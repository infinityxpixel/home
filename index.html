<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baanda - Mission Control</title>
    <!-- React & Tailwind CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Press Start 2P', cursive; background-color: #000; color: #eee; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        @keyframes pulse-green { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loading-pulse { animation: pulse-green 1s infinite; }
        .dino-logo { width: 32px; height: 32px; image-rendering: pixelated; }
        .captcha-box { 
            background: repeating-linear-gradient(45deg, #111, #111 10px, #151515 10px, #151515 20px);
            font-family: monospace;
            letter-spacing: 8px;
            user-select: none;
        }
    </style>

    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyDHUOomjTx1BpWEsSYU2lxqbh6P6zRY7TM",
            authDomain: "baanda.firebaseapp.com",
            projectId: "baanda",
            storageBucket: "baanda.firebasestorage.app",
            messagingSenderId: "285288741018",
            appId: "1:285288741018:web:655d834944da86f6534723"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const MASTER_KEY = "BAANDA_MISSION_KEY_2026";
        const CATEGORIES = {
            SVE: { label: 'SVE', color: '#ffffff' },
            SPORT: { label: 'SPORT', color: '#00ff41' },
            DRUZENJE: { label: 'DRUÅ½ENJE', color: '#ff00ff' },
            IZLASCI: { label: 'IZLASCI', color: '#00ccff' }
        };

        async function getKey() {
            const encoder = new TextEncoder();
            const keyMaterial = encoder.encode(MASTER_KEY.padEnd(32, '0'));
            return await window.crypto.subtle.importKey("raw", keyMaterial, "AES-GCM", false, ["encrypt", "decrypt"]);
        }

        async function encryptData(data) {
            const encoder = new TextEncoder();
            const encodedData = encoder.encode(JSON.stringify(data));
            const key = await getKey();
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, encodedData);
            return {
                iv: btoa(String.fromCharCode(...new Uint8Array(iv))),
                content: btoa(String.fromCharCode(...new Uint8Array(encrypted)))
            };
        }

        async function decryptData(ivB64, cipherB64) {
            try {
                const key = await getKey();
                const iv = new Uint8Array(atob(ivB64).split("").map(c => c.charCodeAt(0)));
                const cipher = new Uint8Array(atob(cipherB64).split("").map(c => c.charCodeAt(0)));
                const decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, cipher);
                return JSON.parse(new TextDecoder().decode(decrypted));
            } catch (e) { return null; }
        }

        const DinoLogo = () => (
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="dino-logo">
                <path d="M12 2H18V4H20V6H22V12H20V14H18V16H16V18H14V20H12V22H4V20H2V10H4V8H6V6H8V4H12V2Z" fill="#00ff41"/>
                <path d="M14 6H16V8H14V6Z" fill="black"/><path d="M6 12H8V14H6V12Z" fill="#008021"/><path d="M10 14H12V16H10V14Z" fill="#008021"/>
            </svg>
        );

        const { useState, useEffect, useMemo } = React;

        function App() {
            const [ads, setAds] = useState([]);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('home');
            const [filter, setFilter] = useState('SVE');
            const [form, setForm] = useState({ nick: '', msg: '', contactType: 'MOBITEL', contactVal: '', category: 'SPORT', location: 'ZAGREB' });
            
            const [captchaCode, setCaptchaCode] = useState('');
            const [userCaptcha, setUserCaptcha] = useState('');
            const genCaptcha = () => setCaptchaCode(Math.floor(1000 + Math.random() * 9000).toString());

            useEffect(() => {
                let unsubscribe;
                auth.signInAnonymously().then(() => {
                    unsubscribe = db.collection("missions").orderBy("createdAt", "desc").onSnapshot(async (snap) => {
                        const items = await Promise.all(snap.docs.map(async d => {
                            const decrypted = await decryptData(d.data().iv, d.data().content);
                            return decrypted ? { ...decrypted, id: d.id } : null;
                        }));
                        setAds(items.filter(Boolean));
                        setLoading(false);
                    });
                });
                return () => unsubscribe && unsubscribe();
            }, []);

            useEffect(() => { if(view === 'add') genCaptcha(); }, [view]);

            const saveMission = async (e) => {
                e.preventDefault();
                if (userCaptcha !== captchaCode) return;
                try {
                    const encrypted = await encryptData({ ...form, createdAt: Date.now() });
                    await db.collection("missions").add({ ...encrypted, createdAt: Date.now() });
                    setView('home');
                    setUserCaptcha('');
                } catch (e) { alert("ERROR"); }
            };

            const filteredAds = useMemo(() => filter === 'SVE' ? ads : ads.filter(a => a.category === filter), [ads, filter]);

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="border-b-4 border-[#111] p-6 flex justify-between items-center bg-black sticky top-0 z-50">
                        <div className="flex items-center gap-4">
                             <DinoLogo />
                             <h1 className="text-[12px] md:text-lg text-white tracking-tighter uppercase">BAANDA</h1>
                             <div className={`w-2 h-2 rounded-full ${loading ? 'bg-yellow-500 loading-pulse' : 'bg-green-500'}`}></div>
                        </div>
                        <div className="text-[6px] text-[#333] uppercase hidden md:block tracking-[3px]">Druzimo se i uzivo!</div>
                    </header>

                    {view === 'home' ? (
                        <>
                            <nav className="flex p-4 gap-4 overflow-x-auto bg-black border-b-2 border-[#111] scrollbar-hide sticky top-[76px] z-40">
                                {Object.keys(CATEGORIES).map(k => (
                                    <button key={k} onClick={() => setFilter(k)} 
                                        className={`px-4 py-2 border-2 transition-all whitespace-nowrap text-[8px] ${filter === k ? 'border-white' : 'border-[#111] text-[#444]'}`}
                                        style={filter === k ? {boxShadow: `3px 3px 0px ${CATEGORIES[k].color}`} : {}}>
                                        {CATEGORIES[k].label}
                                    </button>
                                ))}
                            </nav>

                            <main className="p-4 max-w-2xl mx-auto w-full space-y-6 flex-grow">
                                <button onClick={() => setView('add')} className="w-full bg-[#00ff41] text-black p-6 shadow-[6px_6px_0px_#008021] font-bold active:translate-y-1 active:shadow-none transition-all text-[10px] uppercase">
                                    + NOVA MISIJA
                                </button>
                                
                                {loading ? (
                                    <div className="text-center py-20 text-[#333] text-[8px]">SCANNING_FREQUENCIES...</div>
                                ) : filteredAds.length === 0 ? (
                                    <div className="text-center py-20 text-[#222] text-[8px]">NO_MISSIONS_FOUND</div>
                                ) : (
                                    filteredAds.map(ad => (
                                        <div key={ad.id} className="border-2 p-6 bg-[#080808] animate-in fade-in" style={{borderLeft: `6px solid ${CATEGORIES[ad.category]?.color || '#fff'}`, borderColor: '#111'}}>
                                            <div className="flex justify-between mb-4 text-[#444] text-[7px] uppercase">
                                                <span style={{color: CATEGORIES[ad.category]?.color}}>{ad.category}</span>
                                                <span>{ad.location}</span>
                                            </div>
                                            <div className="mb-2 text-[#666] text-[8px]">@{ad.nick}</div>
                                            <p className="text-white mb-6 leading-relaxed text-[10px]">{ad.msg}</p>
                                            <div className="text-right pt-4 border-t border-[#111]">
                                                <span className="bg-[#000] px-3 py-2 text-[#00ff41] border border-[#222] font-mono text-[9px] tracking-widest">{ad.contactVal}</span>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </main>
                        </>
                    ) : (
                        <main className="p-6 max-w-xl mx-auto w-full border-4 border-[#ff00ff] my-8 bg-black animate-in zoom-in duration-200">
                            <h2 className="text-[#ff00ff] mb-8 text-center uppercase tracking-widest text-[10px]">Nova Operacija</h2>
                            <form onSubmit={saveMission} className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="space-y-2">
                                        <label className="text-[#444] text-[7px] block uppercase">Identitet:</label>
                                        <input maxLength="15" className="w-full bg-black border-2 border-[#222] p-4 outline-none focus:border-[#ff00ff] text-white text-[9px]" onChange={e => setForm({...form, nick: e.target.value})} required />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-[#444] text-[7px] block uppercase">Sektor:</label>
                                        <select className="w-full bg-black border-2 border-[#222] p-4 outline-none text-[#ff00ff] appearance-none text-[9px]" value={form.location} onChange={e => setForm({...form, location: e.target.value})}>
                                            <option value="ZAGREB">ZAGREB</option>
                                            <option value="SPLIT">SPLIT</option>
                                            <option value="OSTALO">OSTALO</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[#444] text-[7px] block uppercase">Tip Misije:</label>
                                    <select className="w-full bg-black border-2 border-[#222] p-4 outline-none text-[#ff00ff] appearance-none text-[9px]" value={form.category} onChange={e => setForm({...form, category: e.target.value})}>
                                        {Object.keys(CATEGORIES).filter(k => k !== 'SVE').map(k => <option key={k} value={k}>{CATEGORIES[k].label}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[#444] text-[7px] block uppercase">Detalji:</label>
                                    <textarea maxLength="250" placeholder="Max 250 znakova..." className="w-full bg-black border-2 border-[#222] p-4 h-32 outline-none focus:border-[#ff00ff] text-white text-[9px] leading-relaxed" onChange={e => setForm({...form, msg: e.target.value})} required></textarea>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[#444] text-[7px] block uppercase">Kontakt kanal:</label>
                                    <div className="flex gap-2 mb-2">
                                        <button type="button" onClick={() => setForm({...form, contactType: 'MOBITEL', contactVal: ''})} className={`flex-1 p-3 border-2 text-[7px] ${form.contactType === 'MOBITEL' ? 'border-[#ff00ff] text-[#ff00ff]' : 'border-[#111] text-[#444]'}`}>MOBITEL</button>
                                        <button type="button" onClick={() => setForm({...form, contactType: 'EMAIL', contactVal: ''})} className={`flex-1 p-3 border-2 text-[7px] ${form.contactType === 'EMAIL' ? 'border-[#ff00ff] text-[#ff00ff]' : 'border-[#111] text-[#444]'}`}>EMAIL</button>
                                    </div>
                                    <input 
                                        className="w-full bg-black border-2 border-[#222] p-4 outline-none focus:border-[#ff00ff] text-white text-[9px]" 
                                        value={form.contactVal}
                                        onChange={e => setForm({...form, contactVal: e.target.value})} 
                                        placeholder={form.contactType === 'MOBITEL' ? "Npr. 091 234..." : "primjer@mail.com"}
                                        required 
                                    />
                                </div>

                                <div className="border-2 border-[#222] p-4 space-y-3 bg-[#050505]">
                                    <div className="flex justify-between items-center">
                                        <label className="text-[#444] text-[7px] uppercase">Anti-Bot Verifikacija:</label>
                                        <span onClick={genCaptcha} className="text-[#333] text-[6px] cursor-pointer hover:text-white underline">REFRESH</span>
                                    </div>
                                    <div className="flex gap-4 items-center">
                                        <div className="captcha-box flex-1 h-12 flex items-center justify-center text-[#ff00ff] text-xl font-bold italic tracking-widest border border-[#333]">
                                            {captchaCode}
                                        </div>
                                        <input 
                                            placeholder="????"
                                            maxLength="4"
                                            className="w-20 bg-black border-2 border-[#222] h-12 text-center text-white outline-none focus:border-[#ff00ff]"
                                            value={userCaptcha}
                                            onChange={e => setUserCaptcha(e.target.value.replace(/\D/g,''))}
                                        />
                                    </div>
                                </div>

                                <button 
                                    disabled={userCaptcha !== captchaCode}
                                    className={`w-full p-5 font-bold shadow-[6px_6px_0px_#8b008b] active:translate-y-1 active:shadow-none uppercase text-[10px] transition-all ${userCaptcha === captchaCode ? 'bg-[#ff00ff] text-white' : 'bg-[#222] text-[#444] cursor-not-allowed shadow-none'}`}
                                >
                                    Lansiraj
                                </button>
                                <button type="button" onClick={() => setView('home')} className="w-full text-[#333] py-2 text-[8px] uppercase">Prekini</button>
                            </form>
                        </main>
                    )}

                    <footer className="p-10 text-center text-[#111] text-[6px] tracking-[4px] uppercase mt-auto">
                        Baanda // P2P_Encrypted_Network // 2026
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</head>
<body>
    <div id="root"></div>
</body>
</html>